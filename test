package com.schwab.cdt.spos.source.job.step.reader;

import com.schwab.cdt.spos.source.service.StreamService;
import com.schwab.cdt.spos.source.spos.SposStreamingClient;
import org.apache.avro.file.DataFileStream;
import org.apache.avro.generic.GenericDatumReader;
import org.apache.avro.generic.GenericRecord;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.batch.item.ExecutionContext;

import java.io.PipedInputStream;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class SposItemReaderTest {

    private SposItemReader sposItemReader;

    @Mock
    private SposStreamingClient sposStreamingClient;

    @Mock
    private StreamService streamService;

    private PipedInputStream pipedInputStream;

    @Mock
    private DataFileStream<GenericRecord> dataFileStream;

    @BeforeEach
    public void setUp() throws Exception {
        MockitoAnnotations.openMocks(this);
        pipedInputStream = new PipedInputStream();
        sposItemReader = new SposItemReader(sposStreamingClient, "test-documentId");
        dataFileStream = mock(DataFileStream.class);
    }

    @Test
    public void testDoOpen() throws Exception {
        Thread thread = new Thread(sposItemReader.streamService);
        thread.start();
        sposItemReader.open(new ExecutionContext());
        assertNotNull(sposItemReader.dataFileStream);
    }

    @Test
    public void testDoRead() throws Exception {
        when(dataFileStream.hasNext()).thenReturn(true, false);
        when(dataFileStream.next()).thenReturn(mock(GenericRecord.class));

        sposItemReader.dataFileStream = dataFileStream;

        GenericRecord result = sposItemReader.read();
        assertNotNull(result);

        result = sposItemReader.read();
        assertNull(result);
    }

    @Test
    public void testDoClose() throws Exception {
        sposItemReader.dataFileStream = dataFileStream;
        sposItemReader.close();
        verify(dataFileStream, times(1)).close();
    }
}
