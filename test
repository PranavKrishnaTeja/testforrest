package com.schwab.cdt.spos.source.job.step.writer;

import com.datastax.oss.driver.api.core.CqlSession;
import com.datastax.oss.driver.api.core.cql.AsyncResultSet;
import com.datastax.oss.driver.api.core.cql.BoundStatement;
import com.datastax.oss.driver.api.core.cql.PreparedStatement;
import com.datastax.oss.driver.api.core.cql.SimpleStatement;
import com.schwab.cdt.spos.source.config.cassandra.CassandraConfig;
import com.schwab.cdt.spos.source.job.aggregate.AggregateFactory;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.batch.item.Chunk;

import java.math.BigDecimal;
import java.util.List;
import java.util.concurrent.CompletionStage;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

class CassandraItemWriterTest {

    @Mock
    private CqlSession session;

    @Mock
    private CassandraConfig cassandraConfig;

    @Mock
    private CompletionStage<AsyncResultSet> completionStage;

    @InjectMocks
    private CassandraItemWriter cassandraItemWriter;

    private PreparedStatement preparedStatement;
    private BoundStatement boundStatement;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);

        // Create a SimpleStatement with a real query
        SimpleStatement simpleStatement = SimpleStatement.newInstance("INSERT INTO test_table (column1) VALUES (?)");

        // Create a mock PreparedStatement and a real BoundStatement
        preparedStatement = mock(PreparedStatement.class);
        boundStatement = simpleStatement.bind(new BigDecimal("100.00"));

        // Set up the session mock to return the preparedStatement and boundStatement
        when(session.prepare(any(SimpleStatement.class))).thenReturn(preparedStatement);
        when(preparedStatement.bind(any())).thenReturn(boundStatement);

        // Mock the executeAsync method to return a completion stage
        when(session.executeAsync(any(BoundStatement.class))).thenReturn(completionStage);
    }

    @Test
    void testWrite() {
        // Arrange
        AggregateFactory.Metadata metadata = new AggregateFactory.Metadata(new BigDecimal("100.00"), "decimal", "column1", null, null);
        AggregateFactory.Columns column = new AggregateFactory.Columns("column1", metadata);

        AggregateFactory.Table table = new AggregateFactory.Table("test_table", List.of(column));

        AggregateFactory.Aggregate aggregate = new AggregateFactory.Aggregate("test_aggregate", new AggregateFactory.SourceSchema("schema_name"), table, "INSERT INTO test_table (column1) VALUES (:column1)");

        List<AggregateFactory.Aggregate> aggregates = List.of(aggregate);

        // Act
        cassandraItemWriter.write(new Chunk<>(aggregates));

        // Assert
        ArgumentCaptor<BoundStatement> boundStatementCaptor = ArgumentCaptor.forClass(BoundStatement.class);
        verify(session).executeAsync(boundStatementCaptor.capture());

        BoundStatement capturedStatement = boundStatementCaptor.getValue();
        assertEquals(boundStatement, capturedStatement);

        // Verify the correct value is set in the BoundStatement
        assertEquals(new BigDecimal("100.00"), capturedStatement.getBigDecimal(0));
    }
}