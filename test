import com.schwab.cdt.spos.source.config.CsvToAvroConfig;
import com.schwab.cdt.spos.source.config.IngestionJobConfig;
import com.schwab.cdt.spos.source.job.step.CsvToAvroConversionStep;
import com.schwab.cdt.spos.source.service.CsvToAvroConverter;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.*;
import org.springframework.batch.core.*;
import org.springframework.batch.core.repository.JobRepository;
import org.springframework.transaction.PlatformTransactionManager;

import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class CsvToAvroConversionStepTest {

    @Mock
    private JobRepository jobRepository;

    @Mock
    private PlatformTransactionManager transactionManager;

    @Mock
    private CsvToAvroConverter csvToAvroConverter;

    @Mock
    private CsvToAvroConfig csvToAvroConfig;

    @Mock
    private IngestionJobConfig ingestionJobConfig;

    @InjectMocks
    private CsvToAvroConversionStep csvToAvroConversionStep;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    void testCsvToAvroConversionStep_Success() throws Exception {
        // Prepare job parameters
        JobParameters jobParameters = new JobParametersBuilder()
                .addString("jobName", "testJob")
                .addString("directory", "testDirectory")
                .toJobParameters();

        // Mock job and conversion configurations
        IngestionJobConfig.Job jobConfig = new IngestionJobConfig.Job("testJob", "testTargetId");
        when(ingestionJobConfig.jobs()).thenReturn(Collections.singletonList(jobConfig));

        CsvToAvroConfig.Conversion conversion = new CsvToAvroConfig.Conversion();
        conversion.setName("testDirectory");
        when(csvToAvroConfig.getConversions()).thenReturn(Collections.singletonList(conversion));

        // Build the step
        Step step = csvToAvroConversionStep.csvToAvroConversionStep();

        // Create a JobExecution and StepExecution
        JobExecution jobExecution = new JobExecution(1L, jobParameters);
        StepExecution stepExecution = new StepExecution("csvToAvroConversionStep", jobExecution);
        stepExecution.setJobParameters(jobParameters);

        // Execute the step
        step.execute(stepExecution);

        // Verify that the converter is called
        verify(csvToAvroConverter).convertCsvToAvro(conversion, "testTargetId");

        // Verify that the step completed successfully
        assertEquals(BatchStatus.COMPLETED, stepExecution.getStatus());
    }

    @Test
    void testCsvToAvroConversionStep_JobNotFound() {
        // Prepare job parameters
        JobParameters jobParameters = new JobParametersBuilder()
                .addString("jobName", "nonExistentJob")
                .addString("directory", "testDirectory")
                .toJobParameters();

        // Mock empty job configurations
        when(ingestionJobConfig.jobs()).thenReturn(Collections.emptyList());

        // Build the step
        Step step = csvToAvroConversionStep.csvToAvroConversionStep();

        // Create a JobExecution and StepExecution
        JobExecution jobExecution = new JobExecution(1L, jobParameters);
        StepExecution stepExecution = new StepExecution("csvToAvroConversionStep", jobExecution);
        stepExecution.setJobParameters(jobParameters);

        // Execute the step and expect an exception
        Exception exception = assertThrows(RuntimeException.class, () -> {
            step.execute(stepExecution);
        });

        // Verify exception message
        assertTrue(exception.getCause().getMessage().contains("Job nonExistentJob not found"));

        // Verify that the converter is not called
        verifyNoInteractions(csvToAvroConverter);
    }
}